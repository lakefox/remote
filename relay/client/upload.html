<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Windows File Explorer</title>
        <style>
            .explorer {
                width: 400px;
                height: 300px;
                border: 1px solid #ccc;
                overflow: auto;
            }

            .folder {
                cursor: pointer;
                user-select: none;
                display: flex;
                align-items: center;
            }

            .file {
                cursor: pointer;
                user-select: none;
                display: flex;
                align-items: center;
            }

            .icon {
                width: 24px;
                height: 24px;
                margin-right: 5px;
            }
        </style>
    </head>
    <body>
        <div class="explorer" id="explorer">
            <!-- File explorer content goes here -->
        </div>
        <script>
            class WindowsFileExplorer {
                #call(event, ...args) {
                    if (this.events[event]) {
                        for (let i = 0; i < this.events[event].length; i++) {
                            this.events[event][i](...args);
                        }
                    }
                }
                constructor(main, fileTree) {
                    this.history;
                    this.container = document.createElement("div");
                    this.container.style.position = "relative";
                    this.container.style.width = "100%";
                    this.container.style.height = "100%";
                    main.appendChild(this.container);

                    this.contents = document.createElement("div");
                    this.contents.style.position = "absolute";
                    this.contents.style.top = "30px";
                    this.contents.style.left = "0";
                    this.contents.style.zIndex = "2";
                    this.container.appendChild(this.contents);

                    this.navBar = document.createElement("div");
                    this.navBar.style.position = "absolute";
                    this.navBar.style.top = "0";
                    this.navBar.style.left = "0";
                    this.navBar.style.zIndex = "2";
                    this.navBar.style.width = "100%";
                    this.navBar.style.height = "30px";
                    this.navBar.style.display = "flex";

                    let navBack = document.createElement("div");
                    navBack.className = "back";
                    navBack.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"></path></svg>`;
                    let navForward = document.createElement("div");
                    navForward.className = "forward";
                    navForward.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z"></path></svg>`;

                    this.navBar.appendChild(navBack);
                    this.navBar.appendChild(navForward);
                    this.container.appendChild(this.navBar);

                    this.fileUpload = document.createElement("input");
                    this.fileUpload.type = "file";
                    this.fileUpload.id = "fileUpload";
                    this.fileUpload.style.display = "none";
                    this.container.appendChild(this.fileUpload);

                    const label = document.createElement("label");
                    label.htmlFor = "fileUpload";
                    label.style.width = "100%";
                    label.style.height = "100%";
                    label.style.display = "block";
                    label.style.position = "absolute";
                    label.style.top = "0";
                    label.style.left = "0";
                    this.container.appendChild(label);

                    this.fileTree = fileTree;
                    this.path = [];
                    this.events = {};
                    this.renderFolder(this.fileTree, this.contents);
                    this.registerClickEvents();
                    this.setupFileInput();
                }

                renderFolder(items, parentElement) {
                    parentElement.innerHTML = "";
                    const explorer = this;
                    for (const item of items) {
                        const div = document.createElement("div");
                        const isFolder = item.at(-1) == "/";

                        const icon = document.createElement("div");
                        icon.classList.add("icon");
                        if (isFolder) {
                            icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 5h-9.586L8.707 3.293A.997.997 0 0 0 8 3H4c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h16c1.103 0 2-.897 2-2V7c0-1.103-.897-2-2-2z"></path></svg>`;
                        } else {
                            icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M6 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6H6zm8 7h-1V4l5 5h-4z"></path></svg>`;
                        }

                        div.appendChild(icon);

                        const text = document.createElement("div");
                        text.className = "text";
                        text.textContent = item;
                        div.appendChild(text);

                        if (isFolder) {
                            div.classList.add("folder");
                            div.addEventListener("click", () => {
                                console.log("dir", item);
                                explorer.#call("dir", item);
                            });
                        } else {
                            div.classList.add("file");
                            div.addEventListener("click", () => {
                                explorer.#call("file", item, (data) => {});
                            });
                        }

                        div.classList.add("clickable");
                        parentElement.appendChild(div);

                        if (isFolder) {
                            div.style.fontWeight = "bold";
                        }
                    }
                }

                registerClickEvents() {
                    const explorer = this;
                    // this.contents.addEventListener("click", function (e) {
                    const target = e.target;
                    const folderName = target.textContent;
                    if (explorer.path.at(-1) != folderName) {
                        explorer.path.push(folderName);
                    }
                    let folderContents = explorer.getFolderContents();

                    explorer.#call(
                        "open",
                        explorer.getCurrentFolderPath() + "/" + folderName
                    );
                }

                getFolderContents() {
                    let tree = this.fileTree;
                    for (const folderName of this.path) {
                        tree = tree[folderName];
                    }
                    return tree;
                }

                setupFileInput() {
                    const fileInput = this.fileUpload;
                    const explorer = this;
                    fileInput.addEventListener("change", function () {
                        const files = fileInput.files;
                        if (files.length > 0) {
                            const folderPath = explorer.getCurrentFolderPath();
                            for (const file of files) {
                                const filePath = folderPath + "/" + file.name;
                                explorer.#call("upload", filePath);
                            }
                        }
                    });
                }

                getCurrentFolderPath() {
                    return this.path.join("/");
                }
                on(event, cb) {
                    if (!this.events[event]) {
                        this.events[event] = [];
                    }
                    this.events[event].push(cb);
                }
            }

            // Example JSON structure
            const fileTree = [
                "README.md",
                "pico.save",
                "start.sh",
                "package-lock.json",
                "relay/",
                "package.json",
                "remote/",
            ];

            // Usage
            const explorer = new WindowsFileExplorer(
                document.getElementById("explorer"),
                fileTree
            );
            explorer.on("upload", (name) => {
                console.log(name);
            });
            explorer.on("open", (name) => {
                console.log(name);
            });
        </script>
    </body>
</html>
